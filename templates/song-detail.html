{{define "content"}}
<div class="exercise-view{{if .EditMode}} edit-mode{{end}}{{if .Song.HideTitles}} cv-hide-titles{{end}}{{if .Song.HideControls}} cv-hide-controls{{end}}{{if .Song.HideDividers}} cv-hide-dividers{{end}}{{if .Song.HideStages}} cv-hide-stages{{end}}{{if .Song.HideCards}} cv-hide-cards{{end}}" id="exercise-view"
     data-song-id="{{.Song.ID}}"
     data-song="{{json .Song}}"
     data-stage-names="{{json .Settings.StageNames}}"
     data-edit-mode="{{if .EditMode}}true{{else}}false{{end}}">

  <!-- ===== PDF Panel (slides in from left when "Show PDF" is clicked in edit mode) ===== -->
  <div class="edit-pdf-panel" id="edit-pdf-panel" style="display:none">
    <div class="edit-pdf-inner">
      <!-- Upload zone (shown when no PDF) -->
      <div class="upload-zone" id="se-upload-zone"
           ondrop="seOnDrop(event)"
           ondragover="event.preventDefault();event.stopPropagation();this.classList.add('drag-over')"
           ondragleave="event.preventDefault();this.classList.remove('drag-over')">
        <div class="upload-content">
          <div class="upload-icon">ðŸ“„</div>
          <p>Drop PDF here or click to upload</p>
          <button class="btn" onclick="document.getElementById('se-file-input').click()">Choose File</button>
          <input type="file" id="se-file-input" accept=".pdf,application/pdf" style="display:none" onchange="seOnFileSelected(event)" />
        </div>
      </div>

      <!-- Upload progress -->
      <div class="upload-progress-area" id="se-upload-progress" style="display:none">
        <span class="spinner"></span>
        <span>Uploading...</span>
      </div>

      <!-- Upload error -->
      <div class="upload-error-bar" id="se-upload-error" style="display:none">
        <span id="se-upload-error-msg"></span>
        <button class="btn small" onclick="document.getElementById('se-upload-error').style.display='none'">Dismiss</button>
      </div>

      <!-- Pages scroll area -->
      <div class="pages-scroll" id="se-pages" style="display:none">
        <div class="page-stack" id="se-pages-inner"></div>
        <div class="selection-rect" id="se-selection-box" style="display:none"></div>
      </div>

      <!-- Zoom controls (floating) -->
      <div class="zoom-controls" id="se-zoom-controls" style="display:none">
        <button class="zoom-btn" onclick="seZoom(-0.25)">âˆ’</button>
        <span class="zoom-level" id="se-zoom-label">100%</span>
        <button class="zoom-btn" onclick="seZoom(0.25)">+</button>
      </div>

      <!-- Close PDF panel button -->
      <button class="edit-pdf-close-btn" onclick="seTogglePdf()" title="Hide PDF">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <!-- Resize handle -->
    <div class="edit-pdf-resize-handle" id="edit-pdf-resize-handle"></div>
  </div>

  <!-- ===== Main Content ===== -->
  <div class="exercise-view-main" id="exercise-view-main">
    <!-- Song Header -->
    <header class="song-header-wrapper"{{if notNil .Song.SpotifyURL}} data-spotify-url="{{derefStr .Song.SpotifyURL}}"{{end}}>
      <div class="song-header">
        <!-- Album art -->
        <div class="song-album-art" id="song-album-art" style="display:none">
          <img id="song-album-art-img" alt="Album art" />
        </div>
        <div class="song-header-left">
          <!-- Title: practice mode shows static, edit mode shows editable -->
          <h1 class="song-title" id="se-title-display">
            <span class="se-view-text">{{.Song.Title}}</span>
            <span class="se-edit-text pd-editable" onclick="seEditField('title')" style="display:none">
              <span class="pd-display-text">{{if .Song.Title}}{{.Song.Title}}{{else}}Song title{{end}}</span>
              <span class="pd-edit-icon">&#9998;</span>
            </span>
          </h1>
          <p class="song-artist" id="se-artist-display">
            <span class="se-view-text">{{.Song.Artist}}</span>
            <span class="se-edit-text pd-editable" onclick="seEditField('artist')" style="display:none">
              <span class="pd-display-text{{if not .Song.Artist}} pd-placeholder{{end}}">{{if .Song.Artist}}{{.Song.Artist}}{{else}}Artist{{end}}</span>
              <span class="pd-edit-icon">&#9998;</span>
            </span>
          </p>
          <div class="song-meta-row" id="se-meta-row">
            <!-- Practice mode meta -->
            <span class="se-view-text">
              {{if .Song.Tempo}}<span class="meta-chip">{{printf "%.0f" (derefFloat .Song.Tempo)}} BPM</span>{{end}}
              {{if .Song.JobID}}<button class="meta-link pdf-link" onclick="openPdfViewer('{{.Song.JobID}}',{{.Song.PageCount}})" title="View PDF"><svg class="meta-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> PDF</button>{{end}}
              {{if notNil .Song.YoutubeURL}}<a class="meta-link" href="{{derefStr .Song.YoutubeURL}}" target="_blank" rel="noopener"><svg class="meta-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.546 12 3.546 12 3.546s-7.505 0-9.377.504A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.504 9.376.504 9.376.504s7.505 0 9.377-.504a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg> YouTube</a>{{end}}
              {{if notNil .Song.SpotifyURL}}<a class="meta-link spotify" href="{{derefStr .Song.SpotifyURL}}" target="_blank" rel="noopener"><svg class="meta-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg> Spotify</a>{{end}}
            </span>
            <!-- Edit mode meta -->
            <span class="se-edit-text" style="display:none">
              <span class="meta-chip pd-editable" id="se-tempo-display" onclick="seEditField('tempo')">
                <span class="pd-display-text{{if not .Song.Tempo}} pd-placeholder{{end}}">{{if .Song.Tempo}}{{printf "%.0f" (derefFloat .Song.Tempo)}} BPM{{else}}BPM{{end}}</span>
                <span class="pd-edit-icon">&#9998;</span>
              </span>
              <span class="meta-link pd-editable" id="se-youtube-display" onclick="seEditField('youtube')">
                <span class="pd-display-text{{if not (notNil .Song.YoutubeURL)}} pd-placeholder{{end}}">YouTube</span>
                <span class="pd-edit-icon">&#9998;</span>
              </span>
              <span class="meta-link spotify pd-editable" id="se-spotify-display" onclick="seEditField('spotify')">
                <span class="pd-display-text{{if not (notNil .Song.SpotifyURL)}} pd-placeholder{{end}}">Spotify</span>
                <span class="pd-edit-icon">&#9998;</span>
              </span>
            </span>
          </div>
        </div>
        <div class="song-header-right">
          <!-- Practice mode buttons -->
          <span class="se-view-text">
            <button class="header-icon-btn" id="notes-toggle-btn" onclick="toggleSongNotes()" title="Notes">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            </button>
            <button class="header-icon-btn" id="metronome-toggle-btn" onclick="toggleMetronome()" title="Metronome">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L8 22h8L12 2z"/><line x1="12" y1="10" x2="18" y2="5"/></svg>
            </button>
            {{if gt .ExerciseCount 0}}
            <button class="header-icon-btn" id="stats-toggle-btn" onclick="toggleStatsDrawer()" title="Stats">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            </button>
            {{end}}
            <span class="header-dropdown-wrap" style="position:relative">
              <button class="header-icon-btn" id="display-toggle-btn" onclick="toggleDisplayDrawer()" title="Display settings">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
              </button>
              <span class="display-actions" id="display-actions">
                <button class="header-icon-btn display-action-btn" id="cv-btn-titles" onclick="toggleCleanViewBtn('titles',this)" title="Exercise titles">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                </button>
                <button class="header-icon-btn display-action-btn" id="cv-btn-controls" onclick="toggleCleanViewBtn('controls',this)" title="Controls bar">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
                <button class="header-icon-btn display-action-btn" id="cv-btn-dividers" onclick="toggleCleanViewBtn('dividers',this)" title="Section dividers">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="10" y2="6"/><line x1="14" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="10" y2="18"/><line x1="14" y1="18" x2="21" y2="18"/></svg>
                </button>
                <button class="header-icon-btn display-action-btn" id="cv-btn-stages" onclick="toggleCleanViewBtn('stages',this)" title="Stage indicators">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>
                </button>
                <button class="header-icon-btn display-action-btn" id="cv-btn-cards" onclick="toggleCleanViewBtn('cards',this)" title="Card borders">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                </button>
              </span>
            </span>
            <!-- Master zoom dropdown + toggle -->
            <span class="header-dropdown-wrap" style="position:relative">
              <button class="header-icon-btn" id="master-zoom-toggle-btn" onclick="toggleMasterZoom()" title="Master zoom">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              </button>
              <span class="master-zoom-actions" id="master-zoom-actions">
                <button class="header-icon-btn master-zoom-action-btn" onclick="masterZoom(-10)" title="Zoom out all">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                </button>
                <button class="header-icon-btn master-zoom-action-btn" onclick="masterZoom(10)" title="Zoom in all">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                </button>
              </span>
            </span>
          </span>
          <!-- Edit mode action dropdown + toggle -->
          <span class="header-dropdown-wrap" style="position:relative">
            <span class="se-edit-actions" id="se-edit-actions">
              <span class="save-error" id="se-save-error" style="display:none"></span>
              <button class="header-icon-btn se-action-btn se-action-pdf" id="se-pdf-toggle-btn" onclick="seTogglePdf()" title="Show PDF">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              </button>
              <button class="header-icon-btn se-action-btn se-action-save" id="se-save-btn" onclick="seSave()" title="Save">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              </button>
            </span>
            <!-- Edit toggle button (always visible) -->
            <button class="header-icon-btn" id="edit-toggle-btn" onclick="seToggleEditMode()" title="Edit song">
              <svg class="icon-edit" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
              <svg class="icon-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><polyline points="20 6 9 17 4 12"/></svg>
            </button>
          </span>
        </div>
      </div>

      <!-- Song Notes (inline slide-down) -->
      <div class="song-notes-section" id="song-notes-section" style="display:none">
        <textarea class="song-notes-textarea" id="song-notes-textarea" placeholder="Practice observations, things to remember, teacher feedback..." rows="3"></textarea>
      </div>

      <!-- Metronome Panel -->
      <div class="metronome-panel-inline" id="metronome-panel" style="display:none"{{if not .Song.Tempo}} data-default-bpm="120"{{else}} data-default-bpm="{{printf "%.0f" (derefFloat .Song.Tempo)}}"{{end}}>
        <div class="metronome-panel-row">
          <div class="metronome-bpm-group">
            <span class="metronome-bpm-display" id="metronome-bpm-display">{{if .Song.Tempo}}{{printf "%.0f" (derefFloat .Song.Tempo)}}{{else}}120{{end}}</span>
            <span class="metronome-bpm-label">BPM</span>
          </div>
          <input type="range" class="metronome-slider" id="metronome-slider" min="20" max="300" value="{{if .Song.Tempo}}{{printf "%.0f" (derefFloat .Song.Tempo)}}{{else}}120{{end}}" oninput="onMetronomeBpmChange(this.value)" />
          <button class="metronome-play-btn" id="metronome-play-btn" onclick="toggleMetronomePlay()">
            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            <svg class="icon-stop" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
          </button>
        </div>
        <div class="metronome-panel-row metronome-secondary-row">
          {{if .Song.Tempo}}
          <div class="metronome-presets">
            <button class="metronome-preset-btn" onclick="setMetronomePercent(50)">50%</button>
            <button class="metronome-preset-btn" onclick="setMetronomePercent(75)">75%</button>
            <button class="metronome-preset-btn active" onclick="setMetronomePercent(100)">100%</button>
          </div>
          {{end}}
          <button class="metronome-tap-btn" onclick="metronomeTap()">Tap</button>
          <div class="metronome-time-sig">
            <button class="metronome-sig-btn active" onclick="setTimeSig(this,'4/4')">4/4</button>
            <button class="metronome-sig-btn" onclick="setTimeSig(this,'3/4')">3/4</button>
            <button class="metronome-sig-btn" onclick="setTimeSig(this,'6/8')">6/8</button>
          </div>
          <div class="metronome-beat-dots" id="metronome-beat-dots">
            <span class="beat-dot"></span><span class="beat-dot"></span><span class="beat-dot"></span><span class="beat-dot"></span>
          </div>
        </div>
      </div>

      <!-- Stats Panel (old inline, kept for reference but hidden â€” replaced by drawer) -->
      {{if gt .ExerciseCount 0}}
      <div class="stats-panel-inline" id="stats-panel" style="display:none">
        <div class="progress-detail-grid">
          <div class="progress-detail-item">
            <span class="progress-detail-value">{{formatDuration .TotalPracticeTime}}</span>
            <span class="progress-detail-label">Total practice</span>
          </div>
          <div class="progress-detail-item">
            <span class="progress-detail-value">{{.TotalReps}}</span>
            <span class="progress-detail-label">Total reps</span>
          </div>
          <div class="progress-detail-item">
            <span class="progress-detail-value">{{.ExerciseCount}}</span>
            <span class="progress-detail-label">Exercises</span>
          </div>
          <div class="progress-detail-item">
            <span class="progress-detail-value">{{relativeTime .LastPracticed}}</span>
            <span class="progress-detail-label">Last practiced</span>
          </div>
        </div>
        <div class="progress-stage-breakdown">
          {{range seq 5}}
          <div class="progress-stage-row">
            <span class="progress-stage-dot" style="background:{{stageColor . | safeCSS}}"></span>
            <span class="progress-stage-name">{{index $.Settings.StageNames (sub . 1)}}</span>
            <span class="progress-stage-count">{{index $.StageCounts (sub . 1)}}</span>
          </div>
          {{end}}
        </div>
      </div>
      {{end}}


      <!-- Edit Mode: Section pills with add/remove -->
      <div class="se-section-nav-wrapper" id="se-section-nav-wrapper" style="display:none">
        <div class="section-nav pd-section-nav" id="se-section-pills"></div>
        <div class="pd-section-popover" id="se-section-popover" style="display:none">
          <button class="quick-add-btn" onclick="seAddSection('intro')">Intro</button>
          <button class="quick-add-btn" onclick="seAddSection('verse')">Verse</button>
          <button class="quick-add-btn" onclick="seAddSection('chorus')">Chorus</button>
          <button class="quick-add-btn" onclick="seAddSection('bridge')">Bridge</button>
          <button class="quick-add-btn" onclick="seAddSection('solo')">Solo</button>
          <button class="quick-add-btn" onclick="seAddSection('break')">Break</button>
          <button class="quick-add-btn" onclick="seAddSection('outro')">Outro</button>
          <div class="pd-custom-row-inline" id="se-custom-row" style="display:none">
            <input type="text" id="se-custom-name" class="form-input custom-name-input" placeholder="Section name" maxlength="50" onkeydown="if(event.key==='Enter')seAddCustomSection()" />
            <button class="btn small primary" onclick="seAddCustomSection()">Add</button>
          </div>
          <button class="quick-add-btn custom-btn" id="se-custom-toggle" onclick="seToggleCustomInput()">+ Custom</button>
          <button class="quick-add-btn pd-popover-done" onclick="seClosePopover()">Done</button>
        </div>
      </div>


      <!-- Practice Controls (hidden in edit mode) -->
      <div class="practice-controls-bar se-view-only">
        {{if gt (len .SectionGroups) 0}}
        <div class="section-nav" id="practice-section-nav">
          {{range .SectionGroups}}
            {{if .Label}}
            <button class="section-pill"
                    data-section-id="{{.Section.ID}}"
                    data-section-ids="{{.Section.ID}}"
                    {{if eq (len .Exercises) 0}}disabled{{end}}
                    style="background:{{stageTint .LowestStage | safeCSS}};border-color:{{stageBorder .LowestStage | safeCSS}};color:{{stageText .LowestStage | safeCSS}}"
                    onclick="toggleSectionFilter(this)"
                    title="{{.Label}}">
              {{.Label}}
            </button>
            {{end}}
          {{end}}
        </div>
        {{end}}
        <div class="practice-controls-right">
          <div class="view-mode-segmented">
            <button class="view-mode-btn active" data-mode="song-order" onclick="setViewMode(this)">Song order</button>
            <button class="view-mode-btn" data-mode="by-section" onclick="setViewMode(this)">By section</button>
          </div>
          <button class="smart-practice-btn" onclick="toggleSmartPractice(this)" title="Suggest practice order">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            <span class="smart-practice-label">Suggest</span>
          </button>
        </div>
      </div>

    </header>

    <!-- ===== Unified Stats Drawer (below the divider) ===== -->
    {{if gt .ExerciseCount 0}}
    <div class="stats-drawer se-view-only" id="stats-drawer"
         data-song-id="{{.Song.ID}}"
         data-stage-names="{{json .Settings.StageNames}}"
         data-stage-counts="{{json .StageCounts}}"
         data-exercise-count="{{.ExerciseCount}}"
         data-total-time="{{.TotalPracticeTime}}"
         data-total-reps="{{.TotalReps}}"
         data-song-json="{{json .Song}}">
      <div class="stats-drawer-inner">
        <!-- Tabs + Close -->
        <div class="stats-drawer-header">
          <div class="stats-drawer-tabs">
            <button class="stats-tab active" data-tab="progress" onclick="switchStatsTab('progress')">Song Progress</button>
            <button class="stats-tab" data-tab="sessions" onclick="switchStatsTab('sessions')">Sessions</button>
          </div>
          <button class="stats-drawer-close" onclick="closeStatsDrawer()" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>

        <!-- Tab: Song Progress -->
        <div class="stats-tab-content active" id="stats-tab-progress">
          <section class="stats-section" id="stats-health-bar-section">
            <h3 class="stats-section-heading">Song Health</h3>
            <div class="stats-health-summary">
              <span class="stats-health-pct" id="stats-health-pct"></span>
              <span class="stats-health-detail" id="stats-health-detail"></span>
            </div>
            <div class="progress-stage-bar stats-health-bar" id="stats-health-bar"></div>
            <div class="stats-health-legend" id="stats-health-legend"></div>
          </section>

          <section class="stats-section" id="stats-heatmap-section">
            <h3 class="stats-section-heading">Your Progress</h3>
            <div class="stats-heatmap" id="stats-heatmap"></div>
          </section>

          <section class="stats-section" id="stats-card-detail-section" style="display:none">
            <h3 class="stats-section-heading">Card Detail</h3>
            <div class="stats-card-detail" id="stats-card-detail"></div>
          </section>
        </div>

        <!-- Tab: Sessions -->
        <div class="stats-tab-content" id="stats-tab-sessions">
          <section class="stats-section" id="stats-weekly-section">
            <h3 class="stats-section-heading">Weekly Practice</h3>
            <div class="stats-weekly-summary" id="stats-weekly-summary">
              <span class="stats-weekly-stat" id="stats-weekly-total">â€”</span>
              <span class="stats-weekly-stat" id="stats-weekly-avg">â€”</span>
              <span class="stats-weekly-stat" id="stats-weekly-streak">â€”</span>
            </div>
            <div class="stats-weekly-nav">
              <button class="stats-week-nav-btn" id="stats-week-prev" onclick="statsWeekNav(-1)" title="Previous week">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <span class="stats-week-label" id="stats-week-label">This week</span>
              <button class="stats-week-nav-btn" id="stats-week-next" onclick="statsWeekNav(1)" title="Next week">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
              </button>
            </div>
            <div class="stats-weekly-chart" id="stats-weekly-chart">
              <div class="stats-weekly-bars" id="stats-weekly-bars"></div>
              <div class="stats-weekly-labels" id="stats-weekly-labels"></div>
            </div>
            <div class="stats-weekly-empty" id="stats-weekly-empty" style="display:none">
              No practice logged this week
            </div>
          </section>

          <div id="stats-bar-detail-anchor"></div>
        </div>
      </div>
    </div>
    {{end}}

    <!-- Exercise Cards -->
    <div id="se-exercises-container">
    {{if eq (len .Song.Exercises) 0}}
      <div class="empty-state" id="se-empty-state">
        <h3>No Exercises Yet</h3>
        <p>Add exercises to get started</p>
        <button class="cta-btn" onclick="seToggleEditMode()">Edit Song</button>
      </div>
    {{else}}
      {{range .SectionGroups}}
      <div class="section-group" id="section-{{.Section.ID}}">
        {{if .Label}}
        <div class="section-divider">
          <span class="section-line"></span>
          <span class="section-label">{{.Label}}</span>
          <span class="section-line"></span>
        </div>
        {{end}}

        {{if eq (len .Exercises) 0}}
          <p class="section-empty">No exercises</p>
        {{else}}
          <div class="expanded-list">
            {{range .Exercises}}
            <div class="expanded-card-wrapper" id="card-{{.ID}}"
                 data-song-id="{{$.Song.ID}}" data-exercise-id="{{.ID}}"
                 data-section-id="{{.SectionID}}"
                 data-stage="{{.Stage}}"
                 data-difficulty="{{.Difficulty}}"
                 data-crop-scale="{{if .CropScale}}{{derefFloat .CropScale}}{{else}}100{{end}}"
                 data-crop-align="{{if .CropAlign}}{{derefStr .CropAlign}}{{else}}left{{end}}"
                 data-total-seconds="{{.TotalPracticedSeconds}}" data-total-reps="{{.TotalReps}}">

              <div class="expanded-card"
                   style="border-left-color:{{stageBorder .Stage | safeCSS}}">
                <div class="card-crop-area" onclick="cardCropClick(this.closest('.expanded-card-wrapper'))">
                  <div class="card-overlay-header">
                    <h3 class="card-title-name se-view-text">{{.Name}}</h3>
                    <input type="text" class="card-title-edit se-edit-text" value="{{.Name}}" placeholder="e.g., Main riff" maxlength="100"
                           oninput="seSetDesc('{{.ID}}',this.value)" onclick="event.stopPropagation()" style="display:none" />
                  </div>

                  {{if and (gt (len .Crops) 0) $.Song.JobID}}
                    {{range $i, $crop := .Crops}}
                    <div class="card-crop-item">
                      <img src="/api/songs/{{$.Song.ID}}/preview/{{$crop.ID}}" alt="crop {{add $i 1}}" class="card-crop-img" loading="lazy"
                           onerror="this.outerHTML='<div class=\'card-crop-placeholder\'><span>Failed to load</span></div>'" />
                    </div>
                    {{end}}
                  {{else}}
                    <div class="card-crop-placeholder"><span>ðŸŽµ</span></div>
                  {{end}}

                </div>

                <!-- Edit mode: delete button (top-right X) -->
                <button class="card-edit-delete-btn se-edit-only" onclick="event.stopPropagation();seDeleteExercise('{{.ID}}')" title="Remove exercise">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </div>

              <!-- Practice controls -->
              <div class="card-controls-bar se-practice-controls" onclick="event.stopPropagation()">
                <select class="card-stage-select" aria-label="Stage"
                        style="color:{{stageColor .Stage | safeCSS}}"
                        onchange="onStageChange(this,'{{$.Song.ID}}','{{.ID}}')">
                  {{$currentStage := .Stage}}
                  {{range seq 5}}
                  <option value="{{.}}" {{if eq . $currentStage}}selected{{end}}>{{index $.Settings.StageNames (sub . 1)}}</option>
                  {{end}}
                </select>
                <button class="card-timer-btn" onclick="cardStartTimer(this.closest('.expanded-card-wrapper'))" title="Start timer">
                  <svg class="icon-play" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                  <svg class="icon-pause" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>
                </button>
                <span class="card-timer-display">{{formatTimer .TotalPracticedSeconds}}</span>
                <span class="card-controls-sep"></span>
                <span class="card-reps-label">Reps</span>
                <span class="card-reps-count">{{.TotalReps}}</span>
                <button class="card-rep-btn" onclick="cardAddReps(this,1)">+1</button>
                <button class="card-rep-btn" onclick="cardAddReps(this,5)">+5</button>
              </div>

              <!-- Edit controls -->
              <div class="card-controls-bar se-edit-controls" onclick="event.stopPropagation()">
                {{$exSectionID := .SectionID}}
                <select class="card-section-select" onchange="seSetSection('{{.ID}}',this.value)">
                  <option value="" disabled{{if not .SectionID}} selected{{end}}>Sectionâ€¦</option>
                  {{range $.SectionGroups}}
                    {{if .Label}}
                    <option value="{{.Section.ID}}"{{if eq .Section.ID $exSectionID}} selected{{end}}>{{.Label}}</option>
                    {{end}}
                  {{end}}
                </select>
                <button class="card-zoom-btn" onclick="event.stopPropagation();cropZoomBtn(this,-10)" title="Zoom out">âˆ’</button>
                <button class="card-zoom-btn" onclick="event.stopPropagation();cropZoomBtn(this,10)" title="Zoom in">+</button>
              </div>
            </div>
            {{end}}
          </div>
        {{end}}
      </div>
      {{end}}
    {{end}}
    </div>

    <div id="practice-backdrop" class="practice-backdrop" style="display:none" onclick="closePractice()"></div>
  </div>
</div>

<!-- PDF Viewer Overlay -->
<div class="pdf-viewer-overlay" id="pdf-viewer-overlay" style="display:none">
  <div class="pdf-viewer-header">
    <span class="pdf-viewer-title">Sheet Music</span>
    <div class="pdf-viewer-controls">
      <button class="pdf-viewer-zoom-btn" onclick="pdfViewerZoom(-0.25)" title="Zoom out">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
      </button>
      <span class="pdf-viewer-zoom-label" id="pdf-viewer-zoom-label">100%</span>
      <button class="pdf-viewer-zoom-btn" onclick="pdfViewerZoom(0.25)" title="Zoom in">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
      </button>
      <button class="pdf-viewer-close-btn" onclick="closePdfViewer()" title="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>
  <div class="pdf-viewer-scroll" id="pdf-viewer-scroll">
    <div class="pdf-viewer-pages" id="pdf-viewer-pages"></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal-backdrop" id="confirm-modal-backdrop" style="display:none">
  <div class="confirm-modal">
    <p class="confirm-modal-msg" id="confirm-modal-msg"></p>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirm-modal-cancel">Cancel</button>
      <button class="confirm-modal-btn confirm" id="confirm-modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<script src="/static/js/timer.js?v={{assetVer}}"></script>
<script src="/static/js/song-edit.js?v={{assetVer}}"></script>
<script src="/static/js/stats-drawer.js?v={{assetVer}}"></script>
{{end}}
