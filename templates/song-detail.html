{{define "content"}}
<div class="exercise-view" id="exercise-view"{{if notNil .Song.CropBgColor}} data-crop-bg-color="{{derefStr .Song.CropBgColor}}"{{end}}>
  <!-- Song Header -->
  <header class="song-header-wrapper"{{if notNil .Song.SpotifyURL}} data-spotify-url="{{derefStr .Song.SpotifyURL}}"{{end}}>
    <div class="song-header">
      <!-- Album art (populated by JS from Spotify oEmbed) -->
      <div class="song-album-art" id="song-album-art" style="display:none">
        <img id="song-album-art-img" alt="Album art" />
      </div>
      <div class="song-header-left">
        <h1 class="song-title">{{.Song.Title}}</h1>
        <p class="song-artist">{{.Song.Artist}}</p>
        <div class="song-meta-row">
          {{if .Song.Tempo}}<span class="meta-chip">{{printf "%.0f" (derefFloat .Song.Tempo)}} BPM</span>{{end}}
          {{if notNil .Song.YoutubeURL}}<a class="meta-link" href="{{derefStr .Song.YoutubeURL}}" target="_blank" rel="noopener"><svg class="meta-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.546 12 3.546 12 3.546s-7.505 0-9.377.504A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.504 9.376.504 9.376.504s7.505 0 9.377-.504a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg> YouTube</a>{{end}}
          {{if notNil .Song.SpotifyURL}}<a class="meta-link spotify" href="{{derefStr .Song.SpotifyURL}}" target="_blank" rel="noopener"><svg class="meta-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg> Spotify</a>{{end}}
        </div>
      </div>
      <div class="song-header-right">
        <div class="song-detail-menu" id="song-detail-menu">
          <button class="edit-song-btn" onclick="toggleSongDetailMenu(event)" title="Options">&#8942;</button>
          <div class="song-detail-dropdown" id="song-detail-dropdown">
            <button class="menu-item" onclick="toggleEditExercises(); closeSongDetailMenu();">
              Edit Exercises
            </button>
            <button class="menu-item" onclick="location.href='/songs/{{.Song.ID}}/edit?from=practice'; closeSongDetailMenu();">
              Edit Song
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Nav Pills -->
    {{if gt (len .SectionGroups) 0}}
    <div class="section-nav">
      {{range .SectionGroups}}
        {{if .Label}}
        <button class="section-pill"
                data-section-id="{{.Section.ID}}"
                {{if eq (len .Exercises) 0}}disabled{{end}}
                style="background:{{stageTint .LowestStage | safeCSS}};border-color:{{stageBorder .LowestStage | safeCSS}};color:{{stageText .LowestStage | safeCSS}}"
                onclick="document.getElementById('section-{{.Section.ID}}')?.scrollIntoView({behavior:'smooth',block:'start'})"
                title="{{.Label}}">
          {{.Label}}
        </button>
        {{end}}
      {{end}}
    </div>
    {{end}}
  </header>

  <hr class="header-separator" />

  <!-- Edit Exercises Toolbar -->
  <div class="edit-exercises-toolbar" id="edit-exercises-toolbar" style="display:none" data-song-id="{{.Song.ID}}">
    <div class="edit-toolbar-header">
      <span class="edit-toolbar-title">Edit Exercises</span>
      <button class="edit-toolbar-done" onclick="toggleEditExercises()">Done</button>
    </div>
    <div class="edit-toolbar-row">
      <label class="edit-toolbar-label">Crop Background</label>
      <div class="edit-toolbar-colors">
        <div class="color-group">
          <span class="color-group-label">Light</span>
          <div class="color-group-swatches">
            <button class="color-swatch{{if not (notNil .Song.CropBgColor)}} active{{end}}" data-color="" style="background:#ffffff;border:1px solid #d1d5db;" onclick="setCropBgColor(this,'')" title="White (default)"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#f5f0e6")}} active{{end}}" data-color="#f5f0e6" style="background:#f5f0e6;" onclick="setCropBgColor(this,'#f5f0e6')" title="Warm"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#e8e4d9")}} active{{end}}" data-color="#e8e4d9" style="background:#e8e4d9;" onclick="setCropBgColor(this,'#e8e4d9')" title="Sepia"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#d4dce6")}} active{{end}}" data-color="#d4dce6" style="background:#d4dce6;" onclick="setCropBgColor(this,'#d4dce6')" title="Cool"></button>
          </div>
        </div>
        <div class="color-group">
          <span class="color-group-label">Dark</span>
          <div class="color-group-swatches">
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#1e1e1e")}} active{{end}}" data-color="#1e1e1e" style="background:#1e1e1e;" onclick="setCropBgColor(this,'#1e1e1e')" title="Dark"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#2d2b1f")}} active{{end}}" data-color="#2d2b1f" style="background:#2d2b1f;" onclick="setCropBgColor(this,'#2d2b1f')" title="Warm Dark"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#1a1f2e")}} active{{end}}" data-color="#1a1f2e" style="background:#1a1f2e;" onclick="setCropBgColor(this,'#1a1f2e')" title="Blue Dark"></button>
            <button class="color-swatch{{if and (notNil .Song.CropBgColor) (eq (derefStr .Song.CropBgColor) "#000000")}} active{{end}}" data-color="#000000" style="background:#000000;" onclick="setCropBgColor(this,'#000000')" title="Black"></button>
          </div>
        </div>
        <div class="color-group">
          <span class="color-group-label">Custom</span>
          <div class="color-group-swatches">
            <label class="color-custom-wrapper" title="Pick a custom color">
              <input type="color" class="color-custom-input" id="crop-bg-custom"
                     value="{{if notNil .Song.CropBgColor}}{{derefStr .Song.CropBgColor}}{{else}}#ffffff{{end}}"
                     onchange="setCropBgColor(null,this.value)" />
              <svg class="color-custom-icon" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-3.12 3.12-1.23-1.21a1 1 0 00-1.42 0 1 1 0 000 1.42l.71.71-8.49 8.49a1 1 0 00-.29.71V19a1 1 0 001 1h2.47a1 1 0 00.71-.29l8.49-8.49.71.71a1 1 0 001.42 0 1 1 0 000-1.42l-1.21-1.23 3.12-3.12a1.004 1.004 0 00.36-.76 1 1 0 00-.48-.77zM6.68 18H5v-1.68l8.03-8.03 1.68 1.68L6.68 18z"/></svg>
            </label>
          </div>
        </div>
      </div>
    </div>
    <p class="edit-toolbar-hint">Drag the bottom edge of each exercise to resize crops.</p>
    <button class="edit-toolbar-regen" onclick="regeneratePreviews(this)" title="Re-crop from source pages at maximum resolution">ðŸ”„ Regenerate HD Previews</button>
  </div>

  {{if eq (len .Song.Exercises) 0}}
    <div class="empty-state">
      <h3>No Exercises Yet</h3>
      <p>Add exercises to get started</p>
      <button class="cta-btn" onclick="location.href='/songs/{{.Song.ID}}/edit'">Add Exercises</button>
    </div>
  {{else}}
    {{range .SectionGroups}}
    <div class="section-group" id="section-{{.Section.ID}}">
      {{if .Label}}
      <div class="section-divider">
        <span class="section-line"></span>
        <span class="section-label">{{.Label}}</span>
        <span class="section-line"></span>
      </div>
      {{end}}

      {{if eq (len .Exercises) 0}}
        <p class="section-empty">No exercises</p>
      {{else}}
        <div class="expanded-list">
          {{range .Exercises}}
          <div class="expanded-card-wrapper" id="card-{{.ID}}"
               data-song-id="{{$.Song.ID}}" data-exercise-id="{{.ID}}"
               data-section-id="{{.SectionID}}"
               data-stage="{{.Stage}}"
               data-crop-scale="{{if .CropScale}}{{derefFloat .CropScale}}{{else}}100{{end}}"
               data-total-seconds="{{.TotalPracticedSeconds}}" data-total-reps="{{.TotalReps}}">

            <!-- The visual card: crop image only -->
            <div class="expanded-card"
                 style="border-left-color:{{stageBorder .Stage | safeCSS}}">
              <div class="card-crop-area" onclick="cardCropClick(this.closest('.expanded-card-wrapper'))"
                   {{if notNil $.Song.CropBgColor}}style="background:{{derefStr $.Song.CropBgColor}}"{{end}}>
                <div class="card-overlay-header">
                  <h3 class="card-title-name">{{.Name}}</h3>
                </div>

                {{if and (gt (len .Crops) 0) $.Song.JobID}}
                  {{range $i, $crop := .Crops}}
                  <div class="card-crop-item">
                    <img src="/api/songs/{{$.Song.ID}}/preview/{{$crop.ID}}" alt="crop {{add $i 1}}" class="card-crop-img" loading="lazy"
                         onerror="this.outerHTML='<div class=\'card-crop-placeholder\'><span>Failed to load</span></div>'" />
                  </div>
                  {{end}}
                {{else}}
                  <div class="card-crop-placeholder"><span>ðŸŽµ</span></div>
                {{end}}

                <!-- Drag handle for crop resize (visible in edit mode) -->
                <div class="card-crop-resize-handle" onmousedown="cropResizeStart(event, this)" ontouchstart="cropResizeStart(event, this)">
                  <span class="resize-handle-bar"></span>
                </div>
              </div>
            </div>

            <!-- Controls below the card -->
            <div class="card-controls-bar" onclick="event.stopPropagation()">
              <select class="card-stage-select" aria-label="Stage"
                      style="color:{{stageColor .Stage | safeCSS}}"
                      onchange="onStageChange(this,'{{$.Song.ID}}','{{.ID}}')">
                {{$currentStage := .Stage}}
                {{range seq 5}}
                <option value="{{.}}" {{if eq . $currentStage}}selected{{end}}>{{index $.Settings.StageNames (sub . 1)}}</option>
                {{end}}
              </select>
              <button class="card-timer-btn" onclick="cardStartTimer(this.closest('.expanded-card-wrapper'))" title="Start timer">
                <svg class="icon-play" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                <svg class="icon-pause" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>
              </button>
              <span class="card-timer-display">{{formatTimer .TotalPracticedSeconds}}</span>
              <span class="card-controls-sep"></span>
              <span class="card-reps-label">Reps</span>
              <span class="card-reps-count">{{.TotalReps}}</span>
              <button class="card-rep-btn" onclick="cardAddReps(this,1)">+1</button>
              <button class="card-rep-btn" onclick="cardAddReps(this,5)">+5</button>
            </div>
          </div>
          {{end}}
        </div>
      {{end}}
    </div>
    {{end}}
  {{end}}

  <!-- Practice backdrop -->
  <div id="practice-backdrop" class="practice-backdrop" style="display:none" onclick="closePractice()"></div>
</div>

<script src="/static/js/timer.js?v=6"></script>
{{end}}
