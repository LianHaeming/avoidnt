{{define "content"}}
<div class="designer-view" id="plan-designer"
     data-mode="{{.Mode}}" data-song-id="{{.SongID}}"
     {{if .Song}}data-song="{{json .Song}}"{{end}}
     data-stage-names="{{json .Settings.StageNames}}">

  <!-- Two-column layout -->
  <div class="designer-two-col">
    <!-- ===== LEFT: PDF VIEWER ===== -->
    <div class="col-pdf" id="col-pdf">
      <!-- Upload zone (shown when no PDF) -->
      <div class="upload-zone" id="pd-upload-zone"
           ondrop="pdOnDrop(event)"
           ondragover="event.preventDefault();event.stopPropagation();this.classList.add('drag-over')"
           ondragleave="event.preventDefault();this.classList.remove('drag-over')">
        <div class="upload-content">
          <div class="upload-icon">üìÑ</div>
          <p>Drop PDF here or click to upload</p>
          <button class="btn" onclick="document.getElementById('pd-file-input').click()">Choose File</button>
          <input type="file" id="pd-file-input" accept=".pdf,application/pdf" style="display:none" onchange="pdOnFileSelected(event)" />
        </div>
      </div>

      <!-- Upload progress -->
      <div class="upload-progress-area" id="pd-upload-progress" style="display:none">
        <span class="spinner"></span>
        <span>Uploading...</span>
      </div>

      <!-- Upload error -->
      <div class="upload-error-bar" id="pd-upload-error" style="display:none">
        <span id="pd-upload-error-msg"></span>
        <button class="btn small" onclick="document.getElementById('pd-upload-error').style.display='none'">Dismiss</button>
      </div>

      <!-- Pages scroll area -->
      <div class="pages-scroll" id="pd-pages" style="display:none">
        <div class="page-stack" id="pd-pages-inner"></div>
        <!-- Selection box overlay -->
        <div class="selection-rect" id="pd-selection-box" style="display:none"></div>
      </div>

      <!-- Zoom controls (floating) -->
      <div class="zoom-controls" id="pd-zoom-controls" style="display:none">
        <button class="zoom-btn" onclick="pdZoom(-0.25)">‚àí</button>
        <span class="zoom-level" id="pd-zoom-label">100%</span>
        <button class="zoom-btn" onclick="pdZoom(0.25)">+</button>
      </div>

      <!-- Hint -->
      <div class="hint" id="pd-crop-hint" style="display:none">Click and drag on the PDF to select a section</div>
    </div>

    <!-- Resize handle -->
    <div class="col-resize-handle" id="resize-right" data-side="right"></div>

    <!-- ===== RIGHT: EDITOR ===== -->
    <div class="col-editor" id="col-editor">
      <div class="editor-scroll">
        {{if eq .Mode "edit"}}
          <a class="back-link" href="javascript:void(0)" onclick="pdDiscard()" style="display:block;text-align:left;margin-bottom:12px">‚Üê Back to song</a>
        {{end}}

        <!-- Song Header (WYSIWYG preview) -->
        <header class="song-header-wrapper pd-header" id="pd-header">
          <div class="song-header">
            <div class="song-album-art" id="pd-album-art" style="display:none">
              <img id="pd-album-art-img" alt="Album art" />
            </div>
            <div class="song-header-left">
              <h1 class="song-title pd-editable" id="pd-title-display" onclick="pdEditField('title')">
                <span class="pd-display-text pd-placeholder">Song title</span>
                <span class="pd-edit-icon">&#9998;</span>
              </h1>
              <p class="song-artist pd-editable" id="pd-artist-display" onclick="pdEditField('artist')">
                <span class="pd-display-text pd-placeholder">Artist</span>
                <span class="pd-edit-icon">&#9998;</span>
              </p>
              <div class="song-meta-row" id="pd-meta-row">
                <span class="meta-chip pd-editable" id="pd-tempo-display" onclick="pdEditField('tempo')">
                  <span class="pd-display-text pd-placeholder">BPM</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
                <span class="meta-link pd-editable" id="pd-youtube-display" onclick="pdEditField('youtube')">
                  <span class="pd-display-text pd-placeholder">YouTube</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
                <span class="meta-link spotify pd-editable" id="pd-spotify-display" onclick="pdEditField('spotify')">
                  <span class="pd-display-text pd-placeholder">Spotify</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
              </div>
            </div>
          </div>
        </header>

        <!-- Section pills (WYSIWYG) -->
        <div class="section-nav pd-section-nav" id="pd-section-pills">
          <!-- Populated by JS -->
        </div>

        <!-- Section add popover (hidden) -->
        <div class="pd-section-popover" id="pd-section-popover" style="display:none">
          <button class="quick-add-btn" onclick="pdAddSection('intro')">Intro</button>
          <button class="quick-add-btn" onclick="pdAddSection('verse')">Verse</button>
          <button class="quick-add-btn" onclick="pdAddSection('chorus')">Chorus</button>
          <button class="quick-add-btn" onclick="pdAddSection('bridge')">Bridge</button>
          <button class="quick-add-btn" onclick="pdAddSection('solo')">Solo</button>
          <button class="quick-add-btn" onclick="pdAddSection('outro')">Outro</button>
          <div class="pd-custom-row-inline" id="pd-custom-row" style="display:none">
            <input type="text" id="pd-custom-name" class="form-input custom-name-input" placeholder="Section name" maxlength="50" onkeydown="if(event.key==='Enter')pdAddCustomSection()" />
            <button class="btn small primary" onclick="pdAddCustomSection()">Add</button>
          </div>
          <button class="quick-add-btn custom-btn" id="pd-custom-toggle" onclick="pdToggleCustomInput()">+ Custom</button>
          <button class="quick-add-btn pd-popover-done" onclick="pdClosePopover()">Done</button>
        </div>

        <!-- Auto-fill with AI (metadata + exercise labeling in one click) -->
        <div class="auto-fill-section" id="pd-autofill-section" style="display:none">
          <button class="auto-fill-btn" id="pd-autofill-btn" onclick="pdAutoFill()" disabled>
            &#10024; Auto-fill with AI
          </button>
          <span class="auto-fill-error" id="pd-analyze-error" style="display:none"></span>
          <span class="auto-fill-info" id="pd-autofill-info" style="display:none"></span>
        </div>

        <hr class="header-separator" />

        <!-- Crop display controls -->
        <div class="pd-crop-toolbar" id="pd-crop-toolbar">
          <div class="pd-crop-toolbar-row">
            <label class="pd-crop-toolbar-label">Background</label>
            <div class="pd-crop-toolbar-colors">
              <button class="color-swatch active" data-color="" style="background:#ffffff;border:1px solid #d1d5db" onclick="pdSetCropBgColor(this,'')" title="White"></button>
              <button class="color-swatch" data-color="#1e1e1e" style="background:#1e1e1e" onclick="pdSetCropBgColor(this,'#1e1e1e')" title="Dark"></button>
              <button class="color-swatch" data-color="#2d2b1f" style="background:#2d2b1f" onclick="pdSetCropBgColor(this,'#2d2b1f')" title="Warm Dark"></button>
              <button class="color-swatch" data-color="#1a1f2e" style="background:#1a1f2e" onclick="pdSetCropBgColor(this,'#1a1f2e')" title="Blue Dark"></button>
              <button class="color-swatch" data-color="#f5f0e6" style="background:#f5f0e6" onclick="pdSetCropBgColor(this,'#f5f0e6')" title="Warm"></button>
              <button class="color-swatch" data-color="#e8e4d9" style="background:#e8e4d9" onclick="pdSetCropBgColor(this,'#e8e4d9')" title="Sepia"></button>
              <button class="color-swatch" data-color="#d4dce6" style="background:#d4dce6" onclick="pdSetCropBgColor(this,'#d4dce6')" title="Cool"></button>
              <label class="color-custom-wrapper" title="Pick a custom color">
                <input type="color" class="color-custom-input" value="#ffffff" onchange="pdSetCropBgColorCustom(this)" title="Custom color" />
                <svg class="color-custom-icon" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-3.12 3.12-1.23-1.21a1 1 0 00-1.42 0 1 1 0 000 1.42l.71.71-8.49 8.49a1 1 0 00-.29.71V19a1 1 0 001 1h2.47a1 1 0 00.71-.29l8.49-8.49.71.71a1 1 0 001.42 0 1 1 0 000-1.42l-1.21-1.23 3.12-3.12a1.004 1.004 0 00.36-.76 1 1 0 00-.48-.77zM6.68 18H5v-1.68l8.03-8.03 1.68 1.68L6.68 18z"/></svg>
              </label>
            </div>
          </div>
          <p class="pd-crop-toolbar-hint">Drag the bottom edge of each exercise to resize.</p>
        </div>

        <!-- Exercises header -->
        <div class="editor-exercises-header">
          <h4>Exercises</h4>
          <span class="progress-badge" id="pd-exercise-badge" style="display:none">
            <span id="pd-exercise-count">0 of 0</span>
          </span>
        </div>

        <!-- Empty state -->
        <div class="right-sidebar-empty" id="pd-exercises-empty">
          <div class="empty-icon">‚úÇÔ∏è</div>
          <p>No exercises yet</p>
          <span class="empty-hint">Draw on the PDF to start</span>
        </div>

        <!-- Exercise cards (song-detail style) -->
        <div class="expanded-list" id="pd-exercise-list" style="display:none">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Footer -->
      <div class="col-right-footer">
        <span class="save-error" id="pd-save-error" style="display:none"></span>
        <span class="save-hint" id="pd-missing-msg" style="display:none" title="">‚ìò</span>
        <div class="col-right-footer-actions">
          <button class="save-btn" id="pd-save-btn" onclick="pdSave()" disabled>
            Save
          </button>
          {{if eq .Mode "edit"}}
          <button class="delete-song-btn" onclick="pdShowDeleteModal()">Delete Song</button>
          {{end}}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal-backdrop" id="confirm-modal-backdrop" style="display:none">
  <div class="confirm-modal">
    <p class="confirm-modal-msg" id="confirm-modal-msg"></p>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirm-modal-cancel">Cancel</button>
      <button class="confirm-modal-btn confirm" id="confirm-modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<script src="/static/js/plan-designer.js?v=9"></script>
{{end}}
