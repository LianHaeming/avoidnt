{{define "content"}}
<div class="designer-view" id="plan-designer"
     data-mode="{{.Mode}}" data-song-id="{{.SongID}}"
     {{if .Song}}data-song="{{json .Song}}"{{end}}
     data-stage-names="{{json .Settings.StageNames}}">

  <!-- Two-column layout -->
  <div class="designer-two-col">
    <!-- ===== LEFT: PDF VIEWER ===== -->
    <div class="col-pdf" id="col-pdf">
      <!-- Upload zone (shown when no PDF) -->
      <div class="upload-zone" id="pd-upload-zone"
           ondrop="pdOnDrop(event)"
           ondragover="event.preventDefault();event.stopPropagation();this.classList.add('drag-over')"
           ondragleave="event.preventDefault();this.classList.remove('drag-over')">
        <div class="upload-content">
          <div class="upload-icon">üìÑ</div>
          <p>Drop PDF here or click to upload</p>
          <button class="btn" onclick="document.getElementById('pd-file-input').click()">Choose File</button>
          <input type="file" id="pd-file-input" accept=".pdf,application/pdf" style="display:none" onchange="pdOnFileSelected(event)" />
        </div>
      </div>

      <!-- Upload progress -->
      <div class="upload-progress-area" id="pd-upload-progress" style="display:none">
        <span class="spinner"></span>
        <span>Uploading...</span>
      </div>

      <!-- Upload error -->
      <div class="upload-error-bar" id="pd-upload-error" style="display:none">
        <span id="pd-upload-error-msg"></span>
        <button class="btn small" onclick="document.getElementById('pd-upload-error').style.display='none'">Dismiss</button>
      </div>

      <!-- Pages scroll area -->
      <div class="pages-scroll" id="pd-pages" style="display:none">
        <div class="page-stack" id="pd-pages-inner"></div>
        <!-- Selection box overlay -->
        <div class="selection-rect" id="pd-selection-box" style="display:none"></div>
      </div>

      <!-- Zoom controls (floating) -->
      <div class="zoom-controls" id="pd-zoom-controls" style="display:none">
        <button class="zoom-btn" onclick="pdZoom(-0.25)">‚àí</button>
        <span class="zoom-level" id="pd-zoom-label">100%</span>
        <button class="zoom-btn" onclick="pdZoom(0.25)">+</button>
      </div>

      <!-- Hint -->
      <div class="hint" id="pd-crop-hint" style="display:none">Click and drag on the PDF to select a section</div>
    </div>

    <!-- Resize handle -->
    <div class="col-resize-handle" id="resize-right" data-side="right"></div>

    <!-- ===== RIGHT: EDITOR ===== -->
    <div class="col-editor" id="col-editor">
      <div class="editor-scroll">
        {{if eq .Mode "edit"}}
          <div class="editor-top-row">
            <a class="back-link" href="javascript:void(0)" onclick="pdDiscard()">‚Üê Back to song</a>
            <button class="delete-song-btn-sm" onclick="pdShowDeleteModal()">Delete Song</button>
          </div>
        {{end}}

        <!-- Song Header (WYSIWYG preview) -->
        <header class="song-header-wrapper pd-header" id="pd-header">
          <div class="song-header">
            <div class="song-album-art" id="pd-album-art" style="display:none">
              <img id="pd-album-art-img" alt="Album art" />
            </div>
            <div class="song-header-left">
              <h1 class="song-title pd-editable" id="pd-title-display" onclick="pdEditField('title')">
                <span class="pd-display-text pd-placeholder">Song title</span>
                <span class="pd-edit-icon">&#9998;</span>
              </h1>
              <p class="song-artist pd-editable" id="pd-artist-display" onclick="pdEditField('artist')">
                <span class="pd-display-text pd-placeholder">Artist</span>
                <span class="pd-edit-icon">&#9998;</span>
              </p>
              <div class="song-meta-row" id="pd-meta-row">
                <span class="meta-chip pd-editable" id="pd-tempo-display" onclick="pdEditField('tempo')">
                  <span class="pd-display-text pd-placeholder">BPM</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
                <span class="meta-link pd-editable" id="pd-youtube-display" onclick="pdEditField('youtube')">
                  <span class="pd-display-text pd-placeholder">YouTube</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
                <span class="meta-link spotify pd-editable" id="pd-spotify-display" onclick="pdEditField('spotify')">
                  <span class="pd-display-text pd-placeholder">Spotify</span>
                  <span class="pd-edit-icon">&#9998;</span>
                </span>
              </div>
            </div>
          </div>
        </header>

        <!-- Section pills (WYSIWYG) -->
        <div class="section-nav pd-section-nav" id="pd-section-pills">
          <!-- Populated by JS -->
        </div>

        <!-- Section add popover (hidden) -->
        <div class="pd-section-popover" id="pd-section-popover" style="display:none">
          <button class="quick-add-btn" onclick="pdAddSection('intro')">Intro</button>
          <button class="quick-add-btn" onclick="pdAddSection('verse')">Verse</button>
          <button class="quick-add-btn" onclick="pdAddSection('chorus')">Chorus</button>
          <button class="quick-add-btn" onclick="pdAddSection('bridge')">Bridge</button>
          <button class="quick-add-btn" onclick="pdAddSection('solo')">Solo</button>
          <button class="quick-add-btn" onclick="pdAddSection('outro')">Outro</button>
          <div class="pd-custom-row-inline" id="pd-custom-row" style="display:none">
            <input type="text" id="pd-custom-name" class="form-input custom-name-input" placeholder="Section name" maxlength="50" onkeydown="if(event.key==='Enter')pdAddCustomSection()" />
            <button class="btn small primary" onclick="pdAddCustomSection()">Add</button>
          </div>
          <button class="quick-add-btn custom-btn" id="pd-custom-toggle" onclick="pdToggleCustomInput()">+ Custom</button>
          <button class="quick-add-btn pd-popover-done" onclick="pdClosePopover()">Done</button>
        </div>

        <!-- Auto-fill with AI (metadata + exercise labeling in one click) -->
        <div class="auto-fill-section" id="pd-autofill-section" style="display:none">
          <button class="auto-fill-btn" id="pd-autofill-btn" onclick="pdAutoFill()" disabled>
            &#10024; Auto-fill with AI
          </button>
          <span class="auto-fill-error" id="pd-analyze-error" style="display:none"></span>
          <span class="auto-fill-info" id="pd-autofill-info" style="display:none"></span>
        </div>

        <hr class="header-separator" />

        <!-- Exercises header -->
        <div class="editor-exercises-header">
          <h4>Exercises</h4>
          <span class="progress-badge" id="pd-exercise-badge" style="display:none">
            <span id="pd-exercise-count">0 of 0</span>
          </span>
        </div>

        <!-- Empty state -->
        <div class="right-sidebar-empty" id="pd-exercises-empty">
          <div class="empty-icon">‚úÇÔ∏è</div>
          <p>No exercises yet</p>
          <span class="empty-hint">Draw on the PDF to start</span>
        </div>

        <!-- Exercise cards (song-detail style) -->
        <div class="expanded-list" id="pd-exercise-list" style="display:none">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Footer -->
      <div class="col-right-footer">
        <span class="save-error" id="pd-save-error" style="display:none"></span>
        <span class="save-hint" id="pd-missing-msg" style="display:none" title="">‚ìò</span>
        <button class="save-btn" id="pd-save-btn" onclick="pdSave()" disabled>
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal-backdrop" id="confirm-modal-backdrop" style="display:none">
  <div class="confirm-modal">
    <p class="confirm-modal-msg" id="confirm-modal-msg"></p>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirm-modal-cancel">Cancel</button>
      <button class="confirm-modal-btn confirm" id="confirm-modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<script src="/static/js/plan-designer.js?v=13"></script>
{{end}}
